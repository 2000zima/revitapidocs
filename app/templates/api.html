{% extends "base.html" %}

<!-- Rendered tempaltes must include header() macro#} -->
{% from '%s' % content import header %}
{% block header %}
    {{ header() }}
{% endblock %}

{% block content %}

    <!-- MODAL SEARCH -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Results: </h4>
          </div>
          <div class="modal-body">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
          </div>
        </div>
      </div>
    </div>
    <!-- MODAL SEARCH -->

    <div class="col-sm-12 col-md-4 col-lg-3" id="sidebar">

        <!-- SIDEBAR SEARCH -->
        <form id="quick-search">
        <div class="form-group" id="sidebarsearch">
        <label class="control-label">Quick Search</label>
          <div class="input-group input-group-sm">
            <input type="text" class="form-control" id="input-search" placeholder="Regex">
              <span class="input-group-btn">
                <button class="btn btn-default" id="btn-search" type="submit" data-toggle="modal" data-target="#myModal">Search</button>
              </span>
          </div>
        </div>
        </form>
        <!-- SIDEBAR SEARCH -->

        <span id="menu-loading" class="small text-muted"><img src="{{ url_for('static', filename="img/loader.gif") }}">
        &nbsp;Loading</span>
        <div id="treeview"></div>

        {# Add Google Search Box #}
        {#{% include 'google_search.html' %}#}

    </div>

    <div class="col-sm-12 col-md-8 col-lg-9" id="main">
        {% if active_href and available_in %}
            <div id='alsofor'>
                <p class="small"><small>
                    API VERSIONS :
                    {% for year in available_in %}
                    <a href="/{{year}}/{{active_href}}"> {{year}} </a>
                    {% endfor %}
                </small></p>
            </div>
        {%endif%}

        {% include '%s' % content %}
        <hr />
        {# <div class="comment-bar">#}
        {% include 'disqus.html' %}
        {# </div>#}
    </div>

{% endblock %}


{% block script %}
<script>

$(document).ready(function() {
    // LOAD MENU
    var string_json
    var ajax = $.getJSON("namespace.json", function(json) {
        string_json = JSON.stringify(json);
        buildMenu()
    });
    ajax.always(function() {
        console.log('Ajax JSON namespace loaded.');
        });

    // LOAD MENU CALL BACK
    function buildMenu() {

        var $searchableTree = $('#treeview').treeview({
              expandIcon: "glyphicon glyphicon-stop",
              collapseIcon: "glyphicon glyphicon-unchecked",
              emptyIcon: "glyphicon glyphicon-unchecked",
            //   selectedIcon: 'glyphicon glyphicon-chevron-right',
              selectedBackColor: "#444",
              selectedColor: "#e0e0e0",
              showBorder: false,
              levels: 1,
              enableLinks: true,
              onhoverColor: '#e0e0e0',
              backColor: '#eee',
              data: string_json,
            });
        var is_desktop = ($(window).width() > 900)
        if (("{{active_href}}" != 'None') && is_desktop){
            // console.log('active_href is not None. Iterating to find matching href');
            var node, activeNodeId, nodeId = 0;
                do {
                    node = $('#treeview').treeview("getNode", nodeId);
                    if (node && node.href == "{{active_href}}") {
                        // console.log(node.nodeId)
                        activeNodeId = node.nodeId
                    };
                    nodeId++;
                    }
                while (node.nodeId != undefined);
                };

        console.log('activeNodeId: '+ activeNodeId)
        if (activeNodeId != undefined){
        // console.log('Found Node.')

        $('#treeview').treeview('revealNode', [ activeNodeId, { silent: false } ]);
        $('#treeview').treeview('toggleNodeSelected', [ activeNodeId, { silent: false } ]);
        } else {console.log('Could not find matching node.')};

        $('#menu-loading').animate({opacity: 0},250);
        $('#menu-loading').remove();

    };

    function search(e){
    var pattern = $('#input-search').val();
    var string_json;
        $.getJSON("/2015/search?query=" + pattern, function(json) {
            results = json;
            // results = JSON.parse(json);
            // results = JSON.stringify(json);
            buildResults(results, pattern)
        });
    };

    function buildResults(results, pattern){
        $('.modal-title').html('Results: <strong>'+pattern+'</stron>');
        $('#modal-loading').show();
        // var output
        var content = ''
        $.each(results, function (index, value) {
        var href = '<a href="' + value.link + '" class="list-group-item">'
        var body = '<small><li class="list-group-item-text">' + value.name +'</li></small></a>'
        content += href+body
        });
        $('.modal-body').html(content);
        // $('#modal-loading').hide();
    };

    $("#quick-search").submit(function(e) {
        e.preventDefault()
        $('.modal-body').html('<span id="menu-loading" class="small text-muted"><img src="{{ url_for('static', filename="img/loader.gif") }}">&nbsp;Loading</span>');
        search()
    });

}); //END OF DOC READY

    </script>

{% endblock %}
