{% extends "base.html" %}

<!-- Rendered tempaltes must include header() macro#} -->
{% from '%s' % content import header with context %}
{% block header %}
<!-- START  API MACRO HEADER -->
    {{ header() }}
<!-- END  API MACRO HEADER -->
{% endblock %}

{% block content %}
<!-- START  API HTML -->

    <!-- MODAL SEARCH -->
    <div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel"></h4>
          </div>
          <div class="modal-body">
            {# <div class="list-group" id="result-div">#}
            <div id="result-div">
            </div>

          </div>
          <div class="modal-footer">
            <span class="text-muted small pull-left" style="line-height:40px">Could not find what you were looking for? Try a
            <a id="google-link" target="=_blank">Google Search</a></span>
            {# <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>#}
          </div>
        </div>
      </div>
    </div>
    <!-- MODAL SEARCH -->

    <!-- START SIDEBAR -->
    <div class="col-sm-12 col-md-5 col-lg-4" id="sidebar">

        <!-- SIDEBAR SEARCH -->
        <div id="sidebar-search">
            <form id="form-quicksearch">
            <div class="form-group">
                <label class="control-label">Quick Search</label>
                  <div class="input-group input-group-sm">
                    <input type="text" class="form-control" id="input-search" placeholder="Regex">
                      <span class="input-group-btn">
                        <button class="btn btn-default" id="btn-search" type="submit" data-toggle="modal" data-target="#searchModal"><span class="glyphicon glyphicon-search"></span></button>
                      </span>
                  </div>
            </div>
            </form>
        </div>
        <!-- SIDEBAR SEARCH -->

        <span id="menu-loading" class="small text-muted"><img src="{{ url_for('static', filename="img/loader.gif") }}">
        &nbsp;Loading</span>
        <!-- START BOOTSTRAP TREEVIEW -->
        <div id="treeview"></div>
        <!-- END BOOTSTRAP TREEVIEW -->

        {# Add Google Search Box #}
        {#{% include 'google_search.html' %}#}

    </div>
    <!-- END SIDEBAR -->

    <!-- START MAIN -->
    <div class="col-sm-12 col-md-7 col-lg-8" id="main-sidebar">

        {% if active_href and available_in %}
            <div id='alsofor'>
                <p class="small"><small>
                    API VERSIONS :
                    {% for year in available_in %}
                    <a href="/{{year}}/{{active_href}}"> {{year}} </a>
                    <span class="spaced"> </span>
                    {% endfor %}
                </small></p>
            </div>
        {%endif%}
        <!-- START MAIN CONTENT -->
        {% include '%s' % content %}
        <!-- END MAIN CONTENT -->

        <!-- START DISQUS -->
        {% include 'disqus.html' %}
        <!-- END DISQUS -->

    </div>
    <!-- END MAIN -->

<!-- END API HTML -->
{% endblock %}


{% block script %}
<!-- START API SCRIPT  -->
<script>
$(document).ready(function() {

    // LOAD MENU
    var string_json
    var ajax = $.getJSON("namespace.json", function(json) {
        string_json = JSON.stringify(json);
        buildMenu()
    });

    // Needs fail handling
    ajax.done(function() {
        console.log('Ajax JSON namespace loaded.');
        });

    // LOAD MENU CALL BACK
    function buildMenu() {

        var $searchableTree = $('#treeview').treeview({
              expandIcon: "glyphicon glyphicon-stop",
              collapseIcon: "glyphicon glyphicon-unchecked",
              emptyIcon: "glyphicon glyphicon-unchecked",
            //   selectedIcon: 'glyphicon glyphicon-chevron-right',
              selectedBackColor: "#666",
              selectedColor: "#fff",
              showBorder: false,
              levels: 1,
              enableLinks: true,
              onhoverColor: '#e0e0e0',
              backColor: '#eee',
              data: string_json,
            });

        var is_desktop = ($(window).width() > 990)
        if (("{{active_href}}" != 'None') && is_desktop){
            console.log('active_href is not None. Iterating to find matching href');
            var node, activeNode
            var activeNodeId, nodeId = 0;
                do {
                    node = $('#treeview').treeview("getNode", nodeId);
                    if (node && node.href == "{{active_href}}") {
                        // console.log(node.nodeId)
                        activeNode = node
                        activeNodeId = node.nodeId
                        break;
                    };
                    nodeId++;
                    }
                while (node.nodeId != undefined);
        };

        if (activeNodeId != undefined){
            // console.log('Found Node.')

            $('#treeview').treeview('revealNode', [ activeNodeId, { silent: false } ]);
            $('#treeview').treeview('toggleNodeSelected', [ activeNodeId, { silent: false } ]);

            var scrollto = $('a[href="' + activeNode.href +'"]').offset().top - 200;
            // $('#sidebar').animate({ scrollTop: scrollto }, 500, "swing");
            $('#sidebar').scrollTop(scrollto); // Scroll, no animation
        }

        else {
            // console.log('Could not find matching node.')
             if (is_desktop) {
                // Auto Expand First level on Desktop
                // console.log("Active Node Not found, but it's a desktop. Open Node1")
                $('#treeview').treeview('revealNode', [ 1, { silent: false } ]);
                };
        };

        console.log("Hiding Loader Gif...")
        $('#menu-loading').animate({opacity: 0},200);
        $('#menu-loading').hide();
        $('#treeview').animate({opacity: 1}, 200);


        // $('#treeview').on('nodeExpanded', function(event, node) {
        //     $(event.target).addClass("node-expanded")
        //     $(event.target).removeClass("node-collapsed")
        // });

    };  // End of Build Menue Call Back Function

    function search(pattern){

    $('.modal-title').html('Query: <strong>'+pattern+'</strong>');
    $('#result-div').html('<span class="small text-muted"><img src="{{ url_for('static', filename="img/loader.gif") }}">&nbsp; Loading</span>');
    $('#google-link').attr("href", "http://www.google.com/search?q=site:www.revitapidocs.com " + pattern)

    var results_json;
    $.getJSON("searchapi?query=" + pattern, function(json) {
        results_json = json;
        })
        .done(function(){
            // Search successful
            buildResults(results_json, pattern)
            ga('send', 'pageview', '?query=' + pattern);
            // console.log('GA PV Sent:' + '?query=' + pattern)
        });
    };

    function buildResults(results, pattern){
        if (pattern.length < 1) { pattern = 'None'}
        // var output
        var content = ''

        if ( results.error ){
            content = results.error
        }
        else{
            $.each(results, function (index, value) {
            var ahref =

            '<div class="result-entry">' +
            '<h5><a href="' + value.href + '">' + value.title + '</a>' +

            '<span class="badge pull-right">' + value.tag + '</span>' + '</h5>' +
            '<p class="member-of small">' + value.namespace + ' : ' + '<a href="' + value.member_of_href +'">' + value.member_of +'</a>' +
            '<span class="small year">' +  value.year.join(' / ') +'</span></p>' +
            // '<span class="member-of small">::' + value.namespace +'</span></p>' +
            '<p class="description small">' + value.description + '</p>' +
            '</div>'


            content += ahref
            });
            $('.modal-title').append('<span class="text-muted small"> [' +  results.length +']</span>');
        };
        $('#result-div').html(content);

    };

    $("#form-quicksearch").submit(function(e) {
        e.preventDefault() // Keeps page from submitting and reloading
        var pattern = $('#input-search').val();
        history.pushState(null, null, '?query=' + pattern + '&#searchModal');
        search(pattern)
    });

    $.urlParam = function(name){
        var url = decodeURIComponent(window.location.href)
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(url);
        if (results==null){
           return null;
        }
        else{
           return results[1] || 0;
        }
    };
    // Build Model and Results From URL
    if(window.location.href.indexOf('#searchModal') != -1) {
    $('#searchModal').modal('show');
    var pattern = $.urlParam('query')
    search(pattern)
    };

    // Sidebar Search
    $("#sidebar").scroll(function(){
    if ($("#sidebar").scrollTop() > 1){
        $("#sidebar-search").css("top", $("#sidebar").scrollTop() + 0 + "px");
        $("#sidebar-search").addClass("bottom-shadow")
        $("#sidebar-search").removeClass("no-bottom-shadow")

    } else {
        $("#sidebar-search").css("top", "0px");
        $("#sidebar-search").addClass("no-bottom-shadow")
        $("#sidebar-search").removeClass("bottom-shadow")
    }
    });




}); //END OF DOC READY

</script>
<!-- END API SCRIPT  -->

{% endblock %}
